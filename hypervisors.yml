---
- hosts: hypervisors
  vars_files:
    - vars/credentials.yml
  roles:
    - common
    - users
    - ssh
    - security
    - dotfiles
    - mailer
    - monitoring
    - ups
    - ipmi
    - virtualization
    - zfs
    - snapraid
    - hdparm
    - pci_passthrough
    - docker
    - services

  tasks:

    - name: Add users to media group
      user: name={{item}} groups=media append=yes
      sudo: true
      with_items: user_groups.media

    - name: Create snapraid user
      user: name=snapraid
      sudo: true

    - name: Add users to snapraid group
      user: name={{item}} groups=snapraid append=yes
      sudo: true
      with_items: user_groups.snapraid

    - name: Add adrien to kvm group
      user: name=adrien groups=kvm append=yes
      sudo: true

    - name: Mount btrfs partitons
      mount: "name={{item.mountpoint}} src='LABEL={{item.label}}' state=present fstype=btrfs opts='{{item.opts}}'"
      sudo: true
      with_items:
        - {mountpoint: '/mnt/snapraid_d1', label: 'snapraid_d1', opts: 'defaults,noatime,nodiratime'}
        - {mountpoint: '/mnt/snapraid_d2', label: 'snapraid_d2', opts: 'defaults,noatime,nodiratime'}
        - {mountpoint: '/mnt/snapraid_d3', label: 'snapraid_d3', opts: 'defaults,noatime,nodiratime'}
        - {mountpoint: '/mnt/snapraid_p1', label: 'snapraid_p1', opts: 'defaults,noatime,nodiratime'}

    - name: Install mhddfs
      apt: package=mhddfs state=installed
      sudo: true

    - name: Mount mhddfs partition
      sudo: true
      mount: 'name=/mnt/media src=mhddfs#/mnt/snapraid_d1/media,/mnt/snapraid_d2/media,/mnt/snapraid_d3/media fstype=fuse opts="mlimit=32G,defaults,noatime,allow_other,nonempty,big_writes,direct_io,fsname=media" state=present'

    - name: Install gparted
      apt: pkg=gparted state=installed
      sudo: true

  post_tasks:

    - name: Check if reboot is required
      stat: path=/var/run/reboot-required
      register: should_reboot

    - name: Reboot the system
      command: reboot
      sudo: true
      when: should_reboot.stat.exists == True
      register: rebooting

    - name: Wait for ssh to come back up
      local_action: wait_for port=22 delay=20 host=10.0.0.11
      when: rebooting|changed
