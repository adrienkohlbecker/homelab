{
    "variables": {
      "aws_region": "{{ env `AWS_REGION` }}",
      "aws_access_key_id": "{{ env `AWS_ACCESS_KEY_ID` }}",
      "aws_secret_access_key": "{{ env `AWS_SECRET_ACCESS_KEY` }}",
      "aws_session_token": "{{ env `AWS_SESSION_TOKEN` }}",
      "packer_env": "{{ env `PACKER_ENV` }}",
      "ejson_private_key": "{{ env `EJSON_PRIVATE_KEY` }}",
      "mandrill_smtp_password": "{{ env `MANDRILL_SMTP_PASSWORD` }}",
      "datadog_api_key": "{{ env `DATADOG_API_KEY` }}",
      "dockerhub_password": "{{ env `DOCKERHUB_PASSWORD` }}",
      "loggly_token": "{{ env `LOGGLY_TOKEN` }}",
      "git_sha": "",
      "git_branch": "",
      "build_number": ""
    },

    "provisioners": [
        {
            "type": "shell",
            "scripts": [
                "{{ template_dir }}/scripts/vagrant.sh",
                "{{ template_dir }}/scripts/parallels.sh",
            ],
            "only": [
              "sharette-parallels",
              "sharette-virtualbox"
            ],
            "override": {
                "sharette-parallels": {
                    "execute_command": "echo 'vagrant'|sudo -S bash '{{.Path}}'"
                },
                "sharette-virtualbox": {
                    "execute_command": "echo 'vagrant'|sudo -S bash '{{.Path}}'"
                }
            }
        },
        {
            "type": "shell",
            "scripts": [
                "{{ template_dir }}/scripts/ansible.sh"
            ],
            "override": {
                "sharette-parallels": {
                    "execute_command": "echo 'vagrant' | sudo -S bash '{{.Path}}'"
                },
                "sharette-virtualbox": {
                    "execute_command": "echo 'vagrant' | sudo -S bash '{{.Path}}'"
                },
                "sharette-ami": {
                    "execute_command": "sudo -S bash '{{.Path}}'"
                }
            }
        },
        {
          "type": "ansible-local",
          "playbook_file": "{{ template_dir }}/../ansible/site.yml",
          "inventory_file": "{{ template_dir }}/../ansible/inventory/{{ user `packer_env` }}-local.ini",
          "playbook_dir": "{{ template_dir }}/../ansible",
          "extra_arguments": ["--extra-vars", "\"credentials_ejson_private_key={{ user `ejson_private_key` }} credentials_mandrill_smtp_password={{ user `mandrill_smtp_password` }} credentials_datadog_api_key={{ user `datadog_api_key` }} credentials_dockerhub_password={{ user `dockerhub_password` }} credentials_loggly_token={{ user `loggly_token` }}\""]
        },
        {
            "type": "shell",
            "only": [
              "sharette-parallels",
              "sharette-virtualbox"
            ],
            "scripts": [
                "{{ template_dir }}/scripts/cleanup.sh",
                "{{ template_dir }}/scripts/zerodisk.sh"
            ],
            "override": {
                "sharette-parallels": {
                    "execute_command": "echo 'vagrant'|sudo -S bash '{{.Path}}'"
                },
                "sharette-virtualbox": {
                    "execute_command": "echo 'vagrant'|sudo -S bash '{{.Path}}'"
                }
            }
        }
    ],
    "builders": [
        {
            "type": "virtualbox-iso",
            "name": "sharette-virtualbox",
            "boot_command": [
                "<esc><esc><enter><wait>",
                "/install/vmlinuz noapic preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
                "debian-installer=en_US auto locale=en_US kbd-chooser/method=us ",
                "hostname={{ .Name }} ",
                "fb=false debconf/frontend=noninteractive ",
                "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA keyboard-configuration/variant=USA console-setup/ask_detect=false ",
                "initrd=/install/initrd.gz -- <enter>"
            ],
            "boot_wait": "10s",
            "disk_size": 8192,
            "guest_os_type": "Ubuntu_64",
            "http_directory": "{{template_dir}}/http",
            "iso_checksum": "a3b345908a826e262f4ea1afeb357fd09ec0558cf34e6c9112cead4bb55ccdfb",
            "iso_checksum_type": "sha256",
            "iso_url": "http://releases.ubuntu.com/trusty/ubuntu-14.04.3-server-amd64.iso",
            "ssh_username": "vagrant",
            "ssh_password": "vagrant",
            "ssh_port": 22,
            "ssh_wait_timeout": "10000s",
            "vm_name": "packer-sharette-virtualbox",
            "shutdown_command": "echo '/sbin/halt -h -p' > shutdown.sh; echo 'vagrant'|sudo -S bash 'shutdown.sh'",
            "guest_additions_path": "VBoxGuestAdditions_{{.Version}}.iso",
            "virtualbox_version_file": ".vbox_version",
            "vboxmanage": [
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--memory",
                    "1536"
                ],
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--cpus",
                    "2"
                ]
            ]
        },
        {
            "type": "parallels-iso",
            "name": "sharette-parallels",
            "boot_command": [
                "<esc><esc><enter><wait>",
                "/install/vmlinuz noapic preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
                "debian-installer=en_US auto locale=en_US kbd-chooser/method=us ",
                "hostname={{ .Name }} ",
                "fb=false debconf/frontend=noninteractive ",
                "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA keyboard-configuration/variant=USA console-setup/ask_detect=false ",
                "initrd=/install/initrd.gz -- <enter>"
            ],
            "boot_wait": "10s",
            "disk_size": 8192,
            "guest_os_type": "ubuntu",
            "http_directory": "{{template_dir}}/http",
            "iso_checksum": "a3b345908a826e262f4ea1afeb357fd09ec0558cf34e6c9112cead4bb55ccdfb",
            "iso_checksum_type": "sha256",
            "iso_url": "http://releases.ubuntu.com/trusty/ubuntu-14.04.3-server-amd64.iso",
            "ssh_username": "vagrant",
            "ssh_password": "vagrant",
            "ssh_port": 22,
            "ssh_wait_timeout": "10000s",
            "shutdown_command": "echo '/sbin/halt -h -p' > shutdown.sh; echo 'vagrant'|sudo -S bash 'shutdown.sh'",
            "parallels_tools_mode": "upload",
            "parallels_tools_guest_path": "prl-tools.iso",
            "parallels_tools_flavor": "lin",
            "prlctl": [
                ["set", "{{.Name}}", "--memsize", "1536"],
                ["set", "{{.Name}}", "--cpus", "2"],
                ["set", "{{.Name}}", "--device-add", "hdd", "--size", "30000"]
            ]
        },
        {
            "type": "amazon-ebs",
            "name": "sharette-ami",
            "region": "{{ user `aws_region` }}",
            "source_ami": "ami-d0c69ba7",
            "instance_type": "t2.large",
            "ssh_username": "ubuntu",
            "ami_name": "infrastructure-{{ user `git_branch` }}-{{ user `git_sha` }}-{{ isotime `20060102150405`}}",
            "enhanced_networking": true,
            "access_key": "{{ user `aws_access_key_id` }}",
            "secret_key": "{{ user `aws_secret_access_key` }}",
            "token": "{{ user `aws_session_token` }}",
            "tags": {
              "Name": "infrastructure",
              "GitSha": "{{ user `git_sha` }}",
              "GitBranch": "{{ user `git_branch` }}",
              "BuildNumber": "{{ user `build_number`}}",
              "BuiltAt": "{{ isotime `20060102150405`}}"
            }
        }
    ],
    "post-processors": [
        {
          "type": "vagrant",
          "only": [
            "sharette-parallels",
            "sharette-virtualbox"
          ],
          "output": "sharette_{{.Provider}}.box"
        }
    ]
}
