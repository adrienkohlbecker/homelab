- name: Add act_runner group
  group:
    name: act_runner
    system: true
  become: true
  tags:
    - act_runner

- name: Add act_runner user
  user:
    name: act_runner
    group: act_runner
    createhome: false
    system: true
    shell: /bin/bash
    home: /mnt/scratch/act_runner
  become: true
  register: act_runner_user
  tags:
    - act_runner

- name: Create configuration directory
  when: not (ansible_check_mode and act_runner_user.changed)
  file:
    dest: "{{ item }}"
    state: directory
    owner: act_runner
    group: act_runner
    mode: "0755"
  become: true
  loop:
    - /mnt/services/act_runner
    - /mnt/scratch/act_runner
    - /mnt/scratch/act_runner/cache
    - /mnt/scratch/act_runner/workdir
  tags:
    - act_runner

- name: Configure act_runner
  template:
    src: config.yml.j2
    dest: /mnt/services/act_runner/config.yml
    owner: act_runner
    group: act_runner
    mode: "0644"
    backup: true
  register: act_runner_conf
  become: true
  tags:
    - act_runner

- name: Check if act_runner is installed
  command: act_runner --version
  register: act_runner_check
  failed_when: false
  changed_when: false
  check_mode: false
  become: true
  tags:
    - act_runner

- name: Install act_runner if needed
  when: '"v0.2.10" not in act_runner_check.stderr'
  get_url:
    url: https://gitea.com/gitea/act_runner/releases/download/v0.2.10/act_runner-0.2.10-linux-amd64
    checksum: sha256:b11753c8fe0143dfbaa392ffc5cc035db551fd7254c145dce512aebc8947542a.
    dest: /usr/local/bin/act_runner
    mode: "0755"
    owner: root
    group: root
  become: true
  tags:
    - act_runner

- name: Register runner
  command: act_runner register -c /mnt/services/act_runner/config.yml --no-interactive --instance https://gitea.{{ inventory_hostname }}.{{ domain }} --token {{ gitea_runner_registration_token }}
  args:
    creates: /mnt/services/act_runner/.runner
  become: true
  become_user: act_runner
  register: act_runner_registration
  tags:
    - act_runner

- name: Load JSON file
  slurp:
    src: /mnt/services/act_runner/.runner
  register: act_runner_settings_b64
  failed_when: false
  become: true
  tags:
    - act_runner

- name: Configure act_runner
  template:
    src: runner.json.j2
    dest: /mnt/services/act_runner/.runner
    owner: act_runner
    group: act_runner
    mode: "0600"
    backup: true
    validate: jq . %s
  vars:
    act_runner_settings_json: "{{ act_runner_settings_b64['content'] | default('e30=') | b64decode | from_json }}"
  register: act_runner_json_conf
  become: true
  tags:
    - act_runner

- name: Install act_runner service
  import_role:
    name: systemd_unit
    tasks_from: template
  vars:
    systemd_unit_src: act_runner.service
    systemd_unit_condition: "{{ not (ansible_check_mode and act_runner_user.changed) }}"
  tags:
    - act_runner

- name: Enable the service
  when: not (ansible_check_mode and (systemd_unit.changed or act_runner_user.changed))
  systemd:
    name: act_runner
    enabled: true
  become: true
  tags:
    - act_runner

- name: Start the service
  when: not (ansible_check_mode and (systemd_unit.changed or act_runner_user.changed))
  systemd:
    name: act_runner
    state: started
  register: systemd_started
  become: true
  tags:
    - act_runner

- name: Restart the service
  when: not (ansible_check_mode and (systemd_unit.changed or act_runner_user.changed)) and ((systemd_unit.changed or act_runner_conf.changed or act_runner_registration.changed or act_runner_json_conf.changed) and not systemd_started.changed)
  systemd:
    name: act_runner
    state: restarted
  become: true
  tags:
    - act_runner

- name: Turn on linger
  command: loginctl enable-linger act_runner
  args:
    creates: /var/lib/systemd/linger/act_runner
  become: true
  tags:
    - act_runner

- name: Enable rootless podman socket
  systemd:
    name: podman.socket
    enabled: true
    scope: user
  become: true
  become_user: act_runner
  tags:
    - act_runner

- name: Start rootless podman socket
  systemd:
    name: podman.socket
    state: started
    scope: user
  register: systemd_started
  become: true
  become_user: act_runner
  tags:
    - act_runner
