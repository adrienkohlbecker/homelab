---

- name: 'Install build-essential'
  apt: package={{ item }} state=installed
  sudo: true
  with_items:
    - build-essential

- name: Download Snapraid
  get_url: url=http://sourceforge.net/projects/snapraid/files/snapraid-6.3.tar.gz/download dest=/usr/local/src/snapraid-6.3.tar.gz
  register: downloaded_snapraid
  sudo: true

- name: Extract Snapraid
  shell: tar -xzf snapraid-6.3.tar.gz chdir=/usr/local/src
  when: downloaded_snapraid|changed
  sudo: true

- name: Compile and install Snapraid
  shell: './configure && make && make install chdir=/usr/local/src/snapraid-6.3'
  when: downloaded_snapraid|changed
  sudo: true

- name: Copy the configuration
  copy: src=snapraid.conf dest=/etc/snapraid.conf
  sudo: true

- name: Copy the sync script
  copy: src=snapraid_sync.sh dest=/usr/local/bin/snapraid_sync mode=755
  sudo: true

- name: Schedule the sync script
  cron: name="snapraid sync" minute=5 hour=23 job="/usr/local/bin/snapraid_sync" user=root cron_file=ansible_snapraid_sync
  sudo: true

- name: Copy the scrub script
  copy: src=snapraid_scrub.sh dest=/usr/local/bin/snapraid_scrub mode=755
  sudo: true

- name: Schedule the scrub script
  cron: name="snapraid scrub" minute=0 hour=1 weekday=0 job="/usr/local/bin/snapraid_scrub" user=root cron_file=ansible_snapraid_scrub
  sudo: true
