- name: Create directory
  file:
    dest: "{{ ansible_facts.user_dir }}/Work/homelab/wireguard"
    state: directory
    owner: "{{ ansible_facts.user_uid }}"
    group: "{{ ansible_facts.user_gid }}"
    mode: "0755"
  tags:
    - wireguard

- name: Create directory
  file:
    dest: "{{ ansible_facts.user_dir }}/Work/homelab/wireguard/{{ item.name }}"
    state: directory
    owner: "{{ ansible_facts.user_uid }}"
    group: "{{ ansible_facts.user_gid }}"
    mode: "0755"
  loop: "{{ wireguard_peers }}"
  tags:
    - wireguard

- name: Generate wireguard configuration
  template:
    src: wg0.conf.j2
    dest: "{{ ansible_facts.user_dir }}/Work/homelab/wireguard/{{ item.name }}/home.conf"
    owner: "{{ ansible_facts.user_uid }}"
    group: "{{ ansible_facts.user_gid }}"
    mode: "0644"
  vars:
    name: "{{ item.name }}"
  loop: "{{ wireguard_peers }}"
  tags:
    - wireguard

- name: Generate wireguard QR code
  shell: "qrencode -t png -o {{ ansible_facts.user_dir }}/Work/homelab/wireguard/{{ item.name }}/qr.png -r {{ ansible_facts.user_dir }}/Work/homelab/wireguard/{{ item.name }}/home.conf"
  loop: "{{ wireguard_peers }}"
  tags:
    - wireguard
