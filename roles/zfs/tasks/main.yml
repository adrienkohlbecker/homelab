---

- name: add ZoL repository
  apt_repository: repo='ppa:zfs-native/stable'
  sudo: true
  register: ppa_added

- name: Update apt
  apt: update_cache=yes
  sudo: true
  when: ppa_added|changed

- name: Install ZoL
  apt: package={{item}} state=installed
  sudo: true
  with_items:
    - ubuntu-zfs
    - zfs-auto-snapshot

- name: Copy the health script
  copy: src=zfs_health.sh dest=/usr/local/bin/zfs_health mode=755
  sudo: true

- name: Schedule the health script
  cron: name="zfs health" minute=55 job="/usr/local/bin/zfs_health" user=root cron_file=ansible_zfs_health
  sudo: true

- name: Copy the scrub script
  copy: src=zfs_scrub.sh dest=/usr/local/bin/zfs_scrub mode=755
  sudo: true

- name: Schedule the scrub script
  cron: name="zfs scrub" minute=0 hour=3 weekday=0 job="/usr/local/bin/zfs_scrub" user=root cron_file=ansible_zfs_scrub
  sudo: true
