- name: Create the traefik podman network
  containers.podman.podman_network:
    name: traefik
  become: true
  register: podman_network_traefik
  tags:
    - traefik

- name: Hotfix network CNI version bug # https://bugs.launchpad.net/ubuntu/+source/libpod/+bug/2024394
  when: not (ansible_check_mode and (podman_network_traefik.changed or 'skipped' in podman_network_traefik))
  replace:
    path: /etc/cni/net.d/traefik.conflist
    regexp: '^(\s*)"cniVersion":(.*)$'
    replace: '\1"cniVersion": "0.4.0",'
    backup: true
    validate: jq . %s
  become: true
  tags:
    - traefik

- name: Check if traefik is installed
  command: traefik version
  register: traefik_check
  failed_when: false
  changed_when: false
  check_mode: false
  become: true
  tags:
    - traefik

- name: Install traefik if needed
  when: '"2.10.6" not in traefik_check.stdout'
  become: true
  tags:
    - traefik
  block:

    - name: Download traefik
      check_mode: false
      get_url:
        url: https://github.com/traefik/traefik/releases/download/v2.10.6/traefik_v2.10.6_linux_amd64.tar.gz
        dest: /tmp/traefik.tar.gz
        mode: '0644'
        owner: root
        group: root
        checksum: sha256:4ac55046e8db8a945ccc2cde19ca3f605830953c13ad11e372a1f7fa7e7fee17

    - name: Install traefik
      unarchive:
        src: /tmp/traefik.tar.gz
        remote_src: true
        dest: /usr/local/bin
        mode: '0755'
        owner: root
        group: root
        include: [ traefik ]
        list_files: true
      register: traefik_installed

    - name: Delete tar file
      file:
        path: /tmp/traefik.tar.gz
        state: absent

- name: Create configuration directory
  file:
    dest: /etc/traefik
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  tags:
    - traefik

- name: Create configuration directory
  file:
    dest: /etc/traefik/dynamic.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  tags:
    - traefik

- name: Configure traefik
  template:
    src: traefik.yml.j2
    dest: /etc/traefik/traefik.yml
    owner: root
    group: root
    mode: "0644"
    backup: true
  register: traefik_yml
  become: true
  tags:
    - traefik

- name: Configure traefik
  template:
    src: tls.yml.j2
    dest: /etc/traefik/dynamic.d/tls.yml
    owner: root
    group: root
    mode: "0644"
    backup: true
  become: true
  tags:
    - traefik

- name: Configure traefik
  template:
    src: api.yml.j2
    dest: /etc/traefik/dynamic.d/api.yml
    owner: root
    group: root
    mode: "0644"
    backup: true
  become: true
  tags:
    - traefik

- name: Configure traefik
  template:
    src: ping.yml.j2
    dest: /etc/traefik/dynamic.d/ping.yml
    owner: root
    group: root
    mode: "0644"
    backup: true
  become: true
  tags:
    - traefik

- name: Install traefik service
  import_role:
    name: systemd_unit
    tasks_from: template
  vars:
    systemd_unit_src: traefik.service
  tags:
    - traefik

- name: Enable the service
  when: not (ansible_check_mode and systemd_unit.changed)
  systemd:
    name: traefik
    enabled: true
  become: true
  tags:
    - traefik

- name: Start the service
  when: not (ansible_check_mode and systemd_unit.changed)
  systemd:
    name: traefik
    state: started
  register: systemd_started
  become: true
  tags:
    - traefik

- name: Restart the service
  when: not (ansible_check_mode and systemd_unit.changed) and (systemd_unit.changed or traefik_yml.changed) and not systemd_started.changed
  systemd:
    name: traefik
    state: restarted
  become: true
  tags:
    - traefik

- name: Configure logrotate
  template:
    src: logrotate.j2
    dest: /etc/logrotate.d/traefik
    owner: root
    group: root
    mode: "0644"
    backup: true
  register: logrotate_conf
  become: true
  tags:
    - traefik

- name: Restart logrotate
  when: logrotate_conf.changed
  systemd:
    name: logrotate
    state: restarted
  become: true
  tags:
    - traefik

- name: Configure external hosts
  template:
    src: external.yml.j2
    dest: /etc/traefik/dynamic.d/external.yml
    owner: root
    group: root
    mode: "0644"
    backup: true
  become: true
  tags:
    - traefik
