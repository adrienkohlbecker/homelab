- name: Install prometheus
  import_role:
    name: apt_unit_masked
    tasks_from: apt
  vars:
    apt_unit_masked_pkg: prometheus
    apt_unit_masked_unit: prometheus.service
    apt_unit_masked_install_recommends: false
  tags:
    - prometheus

- name: Copy the configuration
  template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    mode: "0644"
    owner: root
    group: root
    backup: true
  register: prometheus_conf
  become: true
  tags:
    - prometheus

- name: Enable the service
  when: not (ansible_check_mode and apt_unit_masked.changed) and not docker_test
  systemd:
    name: prometheus
    enabled: true
  become: true
  tags:
    - prometheus

- name: Start the service
  when: not (ansible_check_mode and apt_unit_masked.changed) and not docker_test
  systemd:
    name: prometheus
    state: started
  register: systemd_started
  become: true
  tags:
    - prometheus

- name: Restart the service
  when: not (ansible_check_mode and apt_unit_masked.changed) and not docker_test and (apt_unit_masked.changed or prometheus_conf.changed) and not systemd_started.changed
  systemd:
    name: prometheus
    state: restarted
  become: true
  tags:
    - prometheus

- name: Configure nginx
  import_role:
    name: nginx
    tasks_from: site
  vars:
    nginx_subdomain: prometheus
    nginx_proxy_pass: http://127.0.0.1:9090/
  tags:
    - prometheus
