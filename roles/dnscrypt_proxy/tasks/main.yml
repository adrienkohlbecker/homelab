- name: Install dnscrypt-proxy
  import_role:
    name: apt_unit_masked
    tasks_from: apt
  vars:
    apt_unit_masked_pkg: dnscrypt-proxy
    apt_unit_masked_unit:
      - dnscrypt-proxy.service
      - dnscrypt-proxy.socket
  tags:
    - dnscrypt_proxy
    - _check_stage1

- name: Create override directory
  file:
    dest: /etc/systemd/system/dnscrypt-proxy.socket.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  tags:
    - dnscrypt_proxy

- name: Install dnscrypt-proxy socket override
  import_role:
    name: systemd_unit
    tasks_from: template
  vars:
    systemd_unit_src: override_socket.conf
    systemd_unit_dest: dnscrypt-proxy.socket.d/override.conf
    systemd_unit_verify: dnscrypt-proxy.socket
  tags:
    - dnscrypt_proxy

- name: Save return value
  set_fact:
    socket_systemd_unit: '{{ systemd_unit }}'
  tags:
    - dnscrypt_proxy

- name: Copy dnscrypt-proxy conf
  copy:
    src: dnscrypt-proxy.toml
    dest: /etc/dnscrypt-proxy/dnscrypt-proxy.toml
    mode: "0644"
    owner: root
    group: root
  become: true
  register: dnscrypt_proxy_conf
  tags:
    - dnscrypt_proxy

- name: Enable the service
  when: not (ansible_check_mode and apt_unit_masked.changed)
  systemd:
    name: dnscrypt-proxy
    enabled: true
  become: true
  tags:
    - dnscrypt_proxy

- name: Enable dnscrypt_proxy socket
  import_role:
    name: systemd_unit
    tasks_from: service
  vars:
    systemd_unit_src: dnscrypt-proxy.socket
    systemd_unit_condition: "{{ not (ansible_check_mode and apt_unit_masked.changed) }}"
    systemd_unit_restart: "{{ dnscrypt_proxy_conf.changed or socket_systemd_unit.changed }}"
  tags:
    - dnscrypt_proxy
