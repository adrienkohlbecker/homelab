- name: Gather package facts
  package_facts:
    manager: apt
  no_log: true
  check_mode: false
  tags:
    - eaton_ipp
    - _check_stage1

- name: Install curl
  apt:
    pkg:
      - curl
    cache_valid_time: 3600
  become: true
  tags:
    - eaton_ipp
    - _check_stage1

- name: Install eaton ipp if needed
  when: ansible_architecture == "x86_64" and ("ipp-linux" not in ansible_facts.packages or ansible_facts.packages["ipp-linux"][0].version != "1.75.183")
  become: true
  tags:
    - eaton_ipp
    - _check_stage1
  block:

    - name: Download ipp-linux deb
      check_mode: false
      timeout: 10
      get_url:
        url: https://gitea.lab.fahm.fr/api/packages/adrienkohlbecker/generic/eaton_ipp/1.75/ipp-linux_1.75.183-1_amd64.deb
        dest: /tmp/ipp-linux.deb
        mode: '0644'
        owner: root
        group: root
        checksum: sha256:https://gitea.lab.fahm.fr/api/packages/adrienkohlbecker/generic/eaton_ipp/1.75/checksum.ipp-linux_1.75.183-1_amd64.deb.sha256

    - name: Install ipp-linux
      apt:
        deb: /tmp/ipp-linux.deb
      register: ipp_linux_installed

    - name: Delete deb file
      file:
        path: /tmp/ipp-linux.deb
        state: absent

- name: Enable eaton-ipp service
  import_role:
    name: systemd_unit
    tasks_from: service
  vars:
    systemd_unit_src: eaton-ipp
    systemd_unit_condition: '{{ not (ansible_check_mode and ipp_linux_installed.changed) and ansible_architecture == "x86_64" }}'
    systemd_unit_restart: false
  tags:
    - eaton_ipp

- name: Configure nginx
  import_role:
    name: nginx
    tasks_from: site
  vars:
    nginx_condition: '{{ ansible_architecture == "x86_64" }}'
    nginx_subdomain: ipp
    nginx_proxy_pass: https://localhost:4680/
    nginx_location_conf: |
      # By default the header name is lowercase, and this app expects it in capitalized form, otherwise we can't login.
      proxy_set_header Content-Type      $content_type;
      proxy_set_header Cookie            $http_cookie;
  tags:
    - eaton_ipp
