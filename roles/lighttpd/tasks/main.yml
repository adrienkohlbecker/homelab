- name: Install lighttpd
  import_role:
    name: apt_unit_masked
  vars:
    apt_unit_masked_pkg: lighttpd
    apt_unit_masked_unit: lighttpd.service
  tags:
    - lighttpd

- name: Configure lighttpd
  when: not (ansible_check_mode and apt_unit_masked.changed)
  lineinfile:
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
    insertafter: '{{ item.insertafter | default(omit) }}'
    dest: /etc/lighttpd/lighttpd.conf
    backup: true
  loop:
    - regexp: '^server\.bind'
      line: 'server.bind = "127.0.0.1"'
      insertafter: '^server\.port'
    - regexp: '^server\.port'
      line: 'server.port = 8080'
    - regexp: '^#?server\.errorlog-use-syslog\s'
      line: 'server.errorlog-use-syslog	= "enable"'
    - regexp: '^#?server\.errorlog\s'
      line: '# server.errorlog = "/var/log/lighttpd/error.log"'
    - regexp: '^#?status\.status-url\s'
      line: 'status.status-url = "/server-status"'
  register: lighttpd_conf
  become: true
  tags:
    - lighttpd

- name: Enable modules
  when: not (ansible_check_mode and apt_unit_masked.changed)
  file:
    src: ../conf-available/{{ item }}
    dest: /etc/lighttpd/conf-enabled/{{ item }}
    owner: root
    group: root
    mode: "0644"
    state: link
  loop:
    - 10-cgi.conf
    - 10-accesslog.conf
    - 10-status.conf
  register: lighttpd_mod
  become: true
  tags:
    - lighttpd

- name: Enable the service
  when: not (ansible_check_mode and apt_unit_masked.changed)
  systemd:
    name: lighttpd
    enabled: true
  become: true
  tags:
    - lighttpd

- name: Start the service
  when: not (ansible_check_mode and apt_unit_masked.changed)
  systemd:
    name: lighttpd
    state: started
  become: true
  register: systemd_started
  tags:
    - lighttpd

- name: Restart lighttpd
  when: not (ansible_check_mode and apt_unit_masked.changed) and (lighttpd_conf.changed or lighttpd_mod.changed) and not systemd_started.changed
  systemd:
    name: lighttpd
    state: restarted
  become: true
  tags:
    - lighttpd

- name: Configure logrotate
  import_role:
    name: logrotate
    tasks_from: compression
  vars:
    logrotate_item: /etc/logrotate.d/lighttpd
    logrotate_condition: "{{ not (ansible_check_mode and apt_unit_masked.changed) }}"
  tags:
    - lighttpd
