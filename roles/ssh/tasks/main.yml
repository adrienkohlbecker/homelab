---

- name: Add admin group
  action: group name=ssh state=present

- name: Add users to ssh groups
  action: user name={{item}} groups=ssh append=yes
  with_items: user_groups.ssh
  sudo: true

- name: Add authorized keys
  authorized_key: user={{ item }}
    key="{{ lookup('file', '../../../files/'+item+'_rsa.pub') }}"
    state=present
  with_items: user_groups.ssh
  sudo: true

# - name: Disable writing to authorized keys
#   action: file path=/home/adrien/.ssh/authorized_keys mode=0400

- name: Configure sshd
  action: lineinfile dest=/etc/ssh/sshd_config regexp="{{ item.regexp }}" line="{{ item.line }}" state=present
  notify: Restart ssh
  sudo: true
  with_items:
    - { regexp: "^PasswordAuthentication", line: "PasswordAuthentication no"} # disable password auth
    - { regexp: "^AllowGroups", line: "AllowGroups ssh"} # Only users in the ssh group can login
    - { regexp: "^LoginGraceTime", line: "LoginGraceTime 20"} # Reduce grace time to protect against ddos
    - { regexp: "^PermitRootLogin", line: "PermitRootLogin no"} # Disable root login
