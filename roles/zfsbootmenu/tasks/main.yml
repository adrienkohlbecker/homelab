- name: Download zfsbootmenu
  get_url:
    url: https://github.com/zbm-dev/zfsbootmenu/releases/download/v3.0.1/zfsbootmenu-recovery-x86_64-v3.0.1-linux6.1.EFI
    checksum: sha256:3d4c55147964fdbc2b0042535d9ee117dc51bee82af045040d26ae9dfb9bdf0d
    dest: "{{ item }}"
    mode: "0755"
    owner: root
    group: root
  loop:
    - /boot/efi/EFI/ZBM/VMLINUZ.EFI
    - /boot/efi/EFI/ZBM/VMLINUZ-BACKUP.EFI
  become: true
  register: zfsbootmenu_efi
  tags:
    - zfsbootmenu

# TODO this is a zpool property
# - name: Set bootfs on rpool
#   zfs:
#     name: rpool
#     state: present
#     extra_zfs_properties:
#       'bootfs': 'rpool/ROOT/jammy'
#   become: true
#   tags:
#     - zfsbootmenu

- name: Set default command line
  import_role:
    name: zfsbootmenu
    tasks_from: cmdline
  vars:
    zfsbootmenu_cmdline_file: default
    zfsbootmenu_cmdline_contents: ''
  tags:
    - zfsbootmenu

- name: Ask to reboot
  when: zfsbootmenu_efi.changed
  file:
    path: /var/run/reboot-required
    state: touch
    owner: root
    group: root
    mode: "0644"
  become: true
  tags:
    - zfsbootmenu
