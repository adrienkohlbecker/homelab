---

- name: Set up locales
  locale_gen: name={{item}} state=present
  sudo: true
  with_items:
    - fr_FR.UTF-8
    - en_US.UTF-8

- name: apt-get update
  apt: update_cache=yes cache_valid_time=3600
  sudo: true

- name: apt-get upgrade
  apt: upgrade=full
  sudo: true

- name: Set hostname
  hostname: name={{inventory_hostname}}
  sudo: true

- name: Setup new hostname to loopback in /etc/hosts
  lineinfile: 'dest=/etc/hosts regexp="^127.0.0.1" line="127.0.0.1 localhost {{inventory_hostname}}"'
  sudo: true

- name: 'Install vim, ntp, ntpdate, build-essential'
  apt: pkg={{item}} state=installed
  sudo: true
  with_items:
    - vim
    - ntp
    - ntpdate
    - build-essential

- name: Configure concurrency level
  lineinfile: "dest=/etc/environment regexp='{{item.regexp}}' line='{{item.line}}'"
  sudo: true
  with_items:
    - { regexp: '^CONCURRENCY_LEVEL=', line: 'CONCURRENCY_LEVEL="{{ ansible_processor_vcpus + 1 }}"' }
    - { regexp: '^MAKE_FLAGS=', line: 'MAKE_FLAGS="-j{{ ansible_processor_vcpus + 1 }}"' }

- name: Keep these vars when running sudo
  lineinfile: dest=/etc/sudoers line='Defaults        env_keep="CONCURRENCY_LEVEL MAKE_FLAGS"'
  sudo: true

- name: Download bash framework
  get_url: url=https://raw.githubusercontent.com/adrienkohlbecker/bash-framework/master/main.sh dest=/usr/local/lib/bash-framework mode=755 force=yes
  sudo: true
