- name: site | Configure nginx site
  template:
    src: site.conf.j2
    dest: /etc/nginx/sites-available/{{ subdomain }}
    owner: root
    group: root
    mode: "{{ permissions | default('0644') }}"
    backup: true
  become: true
  register: nginx_static_conf

- name: site | Enable nginx site
  when: not (ansible_check_mode and nginx_static_conf.changed)
  file:
    src: /etc/nginx/sites-available/{{ subdomain }}
    dest: /etc/nginx/sites-enabled/{{ subdomain }}
    state: link
  become: true
  register: nginx_static_conf_enable

- name: site | Reload nginx config
  when: nginx_static_conf.changed or nginx_static_conf_enable.changed
  systemd:
    name: nginx
    state: reloaded
  become: true
