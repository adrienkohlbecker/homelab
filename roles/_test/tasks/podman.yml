- name: _test | Install podman repository
  when: ansible_distribution_major_version == "22"
  shell: |
    set -euo pipefail

    cat <<EOF >/etc/apt/sources.list.d/noble.list
    deb {{ ubuntu_mirror }} noble main restricted universe multiverse
    deb {{ ubuntu_mirror }} noble-updates main restricted universe multiverse
    deb {{ ubuntu_mirror }} noble-backports main restricted universe multiverse
    deb {{ ubuntu_mirror_security }} noble-security main restricted universe multiverse
    EOF

    cat <<EOF >/etc/apt/preferences.d/podman-noble-backport
    Package: podman buildah containernetworking-plugins conmon slirp4netns libc6 libgpgme11t64 libsubid4 libc-bin golang-github-containers-common fuse-overlayfs libglib2.0-0t64 locales libfuse3-3 fuse3
    Pin: release n=noble
    Pin-Priority: 991

    Package: *
    Pin: release n=jammy
    Pin-Priority: 500

    Package: *
    Pin: release o=Ubuntu
    Pin-Priority: -10
    EOF
  args:
    executable: /bin/bash
    creates: /etc/apt/preferences.d/podman-noble-backport
  become: true

- name: Create mount point
  when: zfs_root
  file:
    dest: /var/lib/containers/storage
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Create podman zvol
  when: zfs_root
  zfs:
    name: rpool/podman
    state: present
    extra_zfs_properties:
      volsize: '{{ "20GB" | human_to_bytes }}'
  become: true

- name: Create a ext4 filesystem on podman zvol
  when: zfs_root
  filesystem:
    fstype: ext4
    dev: /dev/zvol/rpool/podman
  become: true

- name: Mount podman zvol
  when: zfs_root
  mount:
    path: /var/lib/containers/storage
    src: /dev/zvol/rpool/podman
    fstype: ext4
    opts: defaults,noatime
    state: mounted
    backup: true
  become: true

- name: _test | Install podman
  shell: |
    set -euo pipefail

    apt-get update
    apt-get install -y --no-install-recommends podman iptables
  args:
    executable: /bin/bash
    creates: /usr/bin/podman
  become: true
