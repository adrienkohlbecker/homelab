- name: _test | Install podman
  import_role:
    name: _test
    tasks_from: podman

- name: _test | Install nginx
  import_role:
    name: _test
    tasks_from: nginx

- name: _test | Setup dependencies
  shell: |
    set -euo pipefail
    mkdir /mnt/services

    podman run -d -p 8086:8086 \
      --name influxdb \
      -e DOCKER_INFLUXDB_INIT_MODE=setup \
      -e DOCKER_INFLUXDB_INIT_USERNAME={{ influxdb_root_user }} \
      -e DOCKER_INFLUXDB_INIT_PASSWORD={{ influxdb_root_password }} \
      -e DOCKER_INFLUXDB_INIT_ORG=home \
      -e DOCKER_INFLUXDB_INIT_BUCKET=default \
      --health-cmd "curl --head --location --fail --silent --show-error --connect-timeout 1 --max-time 5 -o /dev/null http://localhost:8086/health" \
      docker.io/influxdb:2.7.6

    timeout 60s podman wait --condition=healthy influxdb
  args:
    executable: /bin/bash
    creates: /mnt/services
  become: true
