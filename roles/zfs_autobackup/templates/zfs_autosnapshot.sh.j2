#!/bin/bash
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
IFS=$'\n\t'
set -euo pipefail
trap 'eval echo "\# $BASH_COMMAND"' DEBUG

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

failed=0

rescue() {
  set +e
  "$@"
  retval=$?
  set -e

  if [ $retval -ne 0 ]; then
    failed=1
  fi
}

rescue zfs_backup_local

rescue zfs_backup_onsite "{{ external_ips[zfs_autobackup_source_host] }}" "{{ zfs_autobackup_dest_dataset }}"

for dataset in $(zfs get 'autobackup:bak' -t filesystem -H -s local -o name,value | awk -v FS='\t' '$2=="true" {print $1}'); do
  rescue zfs_backup_offsite "{{ (wireguard_peers|selectattr('name', 'eq', 'bunk')|first).address }}" "$dataset"
done

exit $failed
