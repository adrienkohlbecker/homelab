- name: Install nut
  apt:
    pkg:
      - nut-client
    cache_valid_time: 3600
  become: true
  register: apt_install_nut
  tags:
    - nut_monitor
    - _check_stage1

- name: Configure nut upsmon.conf
  when: not (ansible_check_mode and apt_install_nut.changed)
  template:
    src: upsmon.conf.j2
    dest: /etc/nut/upsmon.conf
    backup: true
    owner: root
    group: nut
    mode: "0640"
  become: true
  register: nut_upsmon_conf
  tags:
    - nut_monitor

- name: Configure nut upssched.conf
  when: not (ansible_check_mode and apt_install_nut.changed)
  copy:
    src: upssched.conf
    dest: /etc/nut/upssched.conf
    backup: true
    owner: root
    group: nut
    mode: "0640"
  become: true
  register: nut_upssched_conf
  tags:
    - nut_monitor

- name: Configure nut-notify
  template:
    src: nut-notify.sh.j2
    dest: /usr/local/bin/nut-notify
    owner: root
    group: root
    mode: "0755"
    backup: true
    validate: bash -n %s
  become: true
  tags:
    - nut_monitor

- name: Enable nut_client service
  import_role:
    name: systemd_unit
    tasks_from: service
  vars:
    systemd_unit_src: nut-client
    systemd_unit_condition: "{{ not (ansible_check_mode and apt_install_nut.changed) }}"
    systemd_unit_restart: "{{ nut_upsmon_conf.changed or nut_upssched_conf.changed }}"
  tags:
    - nut_monitor
