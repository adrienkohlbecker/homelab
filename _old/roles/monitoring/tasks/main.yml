---

- name: Download datadog apt key
  apt_key: id=C7A7DA52 keyserver=keyserver.ubuntu.com state=present
  sudo: true

- name: Add datadog repository
  apt_repository: repo='deb http://apt.datadoghq.com/ unstable main' state=present
  sudo: true
  register: added_datadog_repo

- name: Install datadog agent
  apt: pkg=datadog-agent state=installed
  sudo: true
  notify: Restart datadog

- name: Copy datadog configuration
  template: src=datadog.conf.j2 dest=/etc/dd-agent/datadog.conf owner=root group=root mode=0644
  sudo: true
  notify: Restart datadog

- name: Install pip for dogapi
  apt: pkg=python-pip state=installed
  sudo: true

- name: Instal pushover-cli
  pip: name=pushover-cli
  sudo: true

- name: Install smartctl
  apt: pkg=smartmontools state=installed
  sudo: true

  # -d removable : Do not fail if the drive goes missing
  # -n standby,24 : Skip checking if the drive is in standby mode, except when 24 checks have already been skipped
  # -m root : Email root on error
  # -M exec /usr/share/smartmontools/smartd-runner : Default runner for emails
  # -a : Load some common parameters
  #       '-H' to check the SMART health status
  #       '-f' to report failures of Usage (rather than Prefail) Attributes
  #       '-t' to track changes in both Prefailure and Usage Attributes
  #       '-l error' to report increases in the number of ATA errors
  #       '-l selftest' to report increases in the number of Self-Test Log errors
  #       '-l selfteststs' to report changes of Self-Test execution status
  #       '-C 197' to report nonzero values of the current pending sector count
  #       '-U 198' to report nonzero values of the offline pending sector count
  # -W 0,38,42 : Do not log temp changes, log when temp is > 38, alert when temp is > 42
  # -I 194 : Do not log Temperature_Celsius changes
  # -I 190 : Do not log Airflow_Temperature_Cel changes
  # -I 231 : Do not log Temperature changes
  # -I 9 : Do not log Power_On_Hours changes
- name: Configure smartd
  lineinfile: dest=/etc/smartd.conf regexp="^DEVICESCAN" line="DEVICESCAN -d removable -n standby,24 -m root -M exec /usr/share/smartmontools/smartd-runner -a -W 0,40,45 -I 194 -I 190 -I 231 -I 9"
  sudo: true
  notify: Restart smartmontools

- name: Start smartd on boot
  lineinfile: 'dest=/etc/default/smartmontools regexp="^#?start_smartd" line="start_smartd=yes"'
  sudo: true
  notify: Restart smartmontools

- name: Copy the short test script
  copy: src=smart_short_test.sh dest=/usr/local/bin/smart_short_test mode=755
  sudo: true

- name: Schedule the short test script
  cron: name="smart short test" hour=2 minute=0 job="/usr/local/bin/smart_short_test" user=root cron_file=ansible_smart_short_test
  sudo: true

- name: Copy the long test script
  copy: src=smart_long_test.sh dest=/usr/local/bin/smart_long_test mode=755
  sudo: true

- name: Schedule the long test script
  cron: name="smart_long_test" hour=2 minute=30 job="/usr/local/bin/smart_long_test" user=root cron_file=ansible_smart_long_test
  sudo: true
