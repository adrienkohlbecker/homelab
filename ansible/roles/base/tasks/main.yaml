---

- name: Set up locales
  locale_gen:
    name: "{{item}}"
    state: present
  become: yes
  with_items:
    - fr_FR.UTF-8
    - en_US.UTF-8
  tags:
    - base

- name: Set default locale
  copy:
    content: "{{ 'LANG=\"en_US.UTF-8\"\n' }}"
    dest: /etc/default/locale
  become: yes
  tags:
    - base

- name: apt-get update
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes
  tags:
    - base

- name: Install aptitude
  apt:
    pkg: aptitude
    state: present
  become: yes
  tags:
    - base

- name: apt-get upgrade
  apt:
    upgrade: full
  become: yes
  tags:
    - base

- name: Set hostname
  hostname:
    name: "{{inventory_hostname}}"
  become: yes
  tags:
    - base

- name: Setup new hostname to loopback in /etc/hosts (short)
  lineinfile:
    dest: /etc/hosts
    regexp: ^127.0.1.1
    line: "127.0.1.1\t{{inventory_hostname_short}}"
  become: yes
  tags:
    - base

- name: Setup new hostname to loopback in /etc/hosts (long)
  lineinfile:
    dest: /etc/hosts
    regexp: ^127.0.2.1
    line: "127.0.2.1\t{{inventory_hostname}}"
    state: '{{ "absent" if inventory_hostname == inventory_hostname_short else "present" }}'
  become: yes
  tags:
    - base

- name: Install base packages
  apt:
    pkg: "{{item}}"
    state: present
  become: yes
  with_items:
    - acpid
    - fail2ban
    - logrotate
    - unattended-upgrades
    - update-notifier-common
    - ubuntu-minimal
    - grub-pc
    - console-data # keymaps
    - python # ansible dep
    - python-simplejson # ansible dep
    - apt-transport-https
  tags:
    - base

- name: Configure keyboard
  lineinfile:
    dest: /etc/default/keyboard
    regexp: "{{item.regexp}}"
    line: "{{item.line}}"
  become: yes
  with_items:
    - regexp: ^XKBMODEL=
      line: 'XKBMODEL="pc105"'
    - regexp: ^XKBLAYOUT=
      line: 'XKBLAYOUT="fr"'
    - regexp: ^XKBVARIANT=
      line: 'XKBVARIANT="latin9"'
    - regexp: ^XKBOPTIONS=
      line: 'XKBOPTIONS="lv3:ralt_switch"'
  tags:
    - base

- name: Configure concurrency level
  lineinfile:
    dest: /etc/environment
    regexp: "{{item.regexp}}"
    line: "{{item.line}}"
  become: yes
  with_items:
    - regexp: ^CONCURRENCY_LEVEL=
      line: 'CONCURRENCY_LEVEL="{{ ansible_processor_vcpus + 1 }}"'
    - regexp: ^MAKE_FLAGS=
      line: 'MAKE_FLAGS="-j{{ ansible_processor_vcpus + 1 }}"'
  tags:
    - base

- name: Keep these vars when running sudo
  lineinfile:
    dest: /etc/sudoers.d/ansible
    insertafter: EOF
    line: 'Defaults        env_keep="CONCURRENCY_LEVEL MAKE_FLAGS"'
    state: present
    create: yes
    validate: visudo -cf %s
  become: yes
  tags:
    - base

- name: Setup unattended-upgrades (20auto-upgrades)
  copy:
    src: 20auto-upgrades
    dest: "/etc/apt/apt.conf.d/20auto-upgrades"
    owner: root
    group: root
    mode: 01204
  become: yes
  tags:
    - base

- name: Setup unattended-upgrades (50unattended-upgrades)
  copy:
    src: 50unattended-upgrades
    dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - base

- name: Download bash framework
  copy:
    src: bash-framework.sh
    dest: /usr/local/lib/bash-framework
    owner: root
    group: root
    mode: 0755
  become: yes
  tags:
    - base

- name: Configure GRUB
  lineinfile:
    dest: /etc/default/grub
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
    state: present
  become: yes
  with_items: "{{ grub_config }}"
  notify:
    - Update grub
    - Ask to reboot
  tags:
    - base
