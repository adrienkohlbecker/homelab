---

- name: Set up locales
  locale_gen:
    name: "{{item}}"
    state: present
  become: yes
  with_items:
    - fr_FR.UTF-8
    - en_US.UTF-8
  tags:
    - base

- name: Set default locale
  copy:
    content: "{{ 'LANG=\"en_US.UTF-8\"\n' }}"
    dest: /etc/default/locale
  become: yes
  tags:
    - base

- name: apt-get update
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes
  tags:
    - base

- name: apt-get upgrade
  apt:
    upgrade: full
  become: yes
  tags:
    - base

- name: Set hostname
  hostname:
    name: "{{inventory_hostname}}"
  become: yes
  tags:
    - base

- name: Setup new hostname to loopback in /etc/hosts (short)
  lineinfile:
    dest: /etc/hosts
    regexp: ^127.0.1.1
    line: "127.0.1.1\t{{inventory_hostname_short}}"
  become: yes
  tags:
    - base

- name: Setup new hostname to loopback in /etc/hosts (long)
  lineinfile:
    dest: /etc/hosts
    regexp: ^127.0.2.1
    line: "127.0.2.1\t{{inventory_hostname}}"
    state: '{{ "absent" if inventory_hostname == inventory_hostname_short else "present" }}'
  become: yes
  tags:
    - base

- name: Install base packages
  apt:
    pkg:
      - acpid
      - fail2ban
      - logrotate
      - unattended-upgrades
      - update-notifier-common
      - console-data # keymaps
      - python # ansible dep
      - python-simplejson # ansible dep
      - python-apt # ansible dep (for check mode)
      - python-pip
      - apt-transport-https
    state: present
  become: yes
  tags:
    - base

- name: Install pip deps
  pip:
    name: docker-py # ansible dep for docker module
  become: yes
  tags:
    - base

- name: Configure keyboard
  lineinfile:
    dest: /etc/default/keyboard
    regexp: "{{item.regexp}}"
    line: "{{item.line}}"
  become: yes
  with_items:
    - regexp: ^XKBMODEL=
      line: 'XKBMODEL="pc105"'
    - regexp: ^XKBLAYOUT=
      line: 'XKBLAYOUT="fr"'
    - regexp: ^XKBVARIANT=
      line: 'XKBVARIANT="latin9"'
    - regexp: ^XKBOPTIONS=
      line: 'XKBOPTIONS="lv3:ralt_switch"'
  tags:
    - base

- name: Setup unattended-upgrades (20auto-upgrades)
  copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - base

- name: Setup unattended-upgrades (50unattended-upgrades)
  copy:
    src: 50unattended-upgrades
    dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - base
