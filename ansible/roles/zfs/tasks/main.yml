---

- name: Install ZoL
  apt:
    package:
    - linux-image-generic
    - zfsutils-linux
    - zfs-initramfs
    - zfs-zed
    state: present
  become: yes
  tags:
    - zfs

- name: Configure ARC
  copy:
    src: zfs.conf
    dest: /etc/modprobe.d/zfs.conf
    mode: 0755
  become: yes
  notify: Ask to reboot
  tags:
    - zfs

- name: Copy the health script
  copy:
    src: zfs_health.sh
    dest: /usr/local/bin/zfs_health
    mode: 0755
  become: yes
  tags:
    - zfs

- name: Schedule the health script
  cron:
    name: zfs_health
    minute: 55
    job: /usr/local/bin/dms --silent b1de25d002 /usr/bin/systemd-cat --identifier zfs_health /usr/local/bin/zfs_health
    user: root
    cron_file: ansible_zfs_health
  become: yes
  tags:
    - zfs

- name: Copy the zfs tool
  copy:
    src: zfs_snaps.sh
    dest: /usr/local/bin/zfs_snaps
    mode: 0755
  become: yes
  tags:
    - zfs

# - name: Mount swap
#   mount:
#     name: none
#     src: /dev/zvol/rpool/swap
#     state: present
#     fstype: swap
#     opts: defaults,discard
#   become: yes
#   register: swap_fstab
#   tags:
#     - zfs
#
# - name: Enable swap
#   command: swapon -av
#   when: swap_fstab is changed
#   become: yes
#   tags:
#     - zfs
