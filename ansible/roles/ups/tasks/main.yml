---

- name: Install apcupsd & mailutils (for email notifications)
  apt:
    pkg: "{{item}}"
    state: installed
  with_items:
    - apcupsd
    - mailutils
  become: yes
  tags:
    - ups

- name: Configure apcupsd
  lineinfile:
    dest: /etc/apcupsd/apcupsd.conf
    regexp: "^#?{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  become: yes
  notify: Restart apcupsd
  with_items:
    - regexp: UPSNAME
      line: UPSNAME smartups
    - regexp: UPSCABLE
      line: UPSCABLE usb
    - regexp: UPSTYPE
      line: UPSTYPE usb
    - regexp: DEVICE
      line: '#DEVICE /dev/ttyS0'
  tags:
    - ups

- name: Configure apcupsd
  lineinfile:
    dest: /etc/default/apcupsd
    regexp: ^ISCONFIGURED
    line: ISCONFIGURED=yes
  become: yes
  notify: Restart apcupsd
  tags:
    - ups
