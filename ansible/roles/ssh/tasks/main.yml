---

- name: Install ssh server
  apt:
    pkg: openssh-server
  become: yes
  tags:
    - ssh

- name: Ensure ssh group is present
  group:
    name: ssh
    state: present
  become: yes
  tags:
    - ssh

- name: Configure sshd
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    insertafter: ^# Authentication
    state: present
  notify: Restart ssh
  become: yes
  tags:
    - ssh
  with_items:
    # disable password auth
    - regexp: ^PasswordAuthentication
      line: PasswordAuthentication no
    # Only users in the ssh group can login
    - regexp: ^(# ?)?AllowGroups
      line: AllowGroups ssh
    # Reduce grace time to protect against ddos
    - regexp: ^LoginGraceTime
      line: LoginGraceTime 10
    # Disable root login
    - regexp: ^PermitRootLogin
      line: PermitRootLogin no

# Fixes warning sshd:  error: Could not load host key: /etc/ssh/ssh_host_ed25519_key
- name: Generate missing host keys
  shell: ssh-keygen -A
  args:
    creates: /etc/ssh/ssh_host_ed25519_key
  become: yes
  tags:
    - ssh

# vagrant
- name: Add provisioning user to ssh group
  user:
    name: "{{ provisioning_user }}"
    groups: ssh
    append: yes
  when: is_vagrant
  become: yes
  tags:
    - ssh
