---

- name: Download datadog apt key
  apt_key:
    id: 382E94DE
    keyserver: keyserver.ubuntu.com
    state: present
  become: yes
  tags:
    - datadog

- name: Add datadog repository
  apt_repository:
    repo: deb http://apt.datadoghq.com/ stable 6
    state: present
  become: yes
  tags:
    - datadog

- name: Install datadog agent
  apt:
    pkg: datadog-agent
    state: present
  become: yes
  tags:
    - datadog

- name: Configure the agent
  template:
    src: datadog.yaml
    dest: /etc/datadog-agent/datadog.yaml
    owner: dd-agent
    group: dd-agent
    mode: 0644
  notify: Restart datadog
  become: yes
  tags:
    - datadog

- name: Create journald config dir
  file:
    dest: /etc/datadog-agent/conf.d/journal.d
    state: directory
    owner: dd-agent
    group: dd-agent
    mode: 0755
  become: yes
  tags:
    - datadog

- name: Configure journald integration
  copy:
    src: journald.yaml
    dest: /etc/datadog-agent/conf.d/journal.d/conf.yaml
    owner: dd-agent
    group: dd-agent
    mode: 0644
  notify: Restart datadog
  become: yes
  tags:
    - datadog
