---

- name: Install smartctl
  apt:
    pkg: smartmontools
    cache_valid_time: 3600
  become: yes
  tags:
    - smart

- name: Divert smartd.conf
  community.general.dpkg_divert:
    path: /etc/smartd.conf
  become: yes
  tags:
    - smart

- name: Configure smartd
  copy:
    src: smartd.conf
    dest: /etc/smartd.conf
    owner: root
    group: root
    mode: "0644"
    backup: yes
  register: smartd_cfg
  become: yes
  tags:
    - smart

- name: Configure smartmontools
  copy:
    src: smartmontools
    dest: /etc/default/smartmontools
    owner: root
    group: root
    mode: "0644"
    backup: yes
  register: smartmontools_cfg
  become: yes
  tags:
    - smart

- name: Restart smartmontools
  when: smartd_cfg.changed or smartmontools_cfg.changed
  service:
    name: smartmontools
    state: restarted
  become: yes
  tags:
    - smart

- name: Copy the short test script
  copy:
    src: smart_short_test.sh
    dest: /usr/local/bin/smart_short_test
    owner: root
    group: root
    mode: "0755"
    backup: yes
  become: yes
  tags:
    - smart

- name: Schedule the short test script
  cron:
    name: smart_short_test
    hour: 0
    minute: 10
    job: /usr/bin/systemd-cat --identifier smart_short_test /usr/local/bin/smart_short_test
    user: root
    cron_file: ansible_smart_short_test
    backup: yes
  become: yes
  tags:
    - smart

- name: Copy the long test script
  copy:
    src: smart_long_test.sh
    dest: /usr/local/bin/smart_long_test
    owner: root
    group: root
    mode: "0755"
    backup: yes
  become: yes
  tags:
    - smart

- name: Schedule the long test script
  cron:
    name: smart_long_test
    hour: 0
    minute: 35
    job: /usr/bin/systemd-cat --identifier smart_long_test /usr/local/bin/smart_long_test
    user: root
    cron_file: ansible_smart_long_test
    backup: yes
  become: yes
  tags:
    - smart
