---

- name: Create a network
  docker_network:
    name: usenet
  become: yes
  tags:
    - services
  register: usenet_docker_network_output

- name: Set fact with usenet docker network gateway
  set_fact:
    usenet_docker_network_gateway: "{{ usenet_docker_network_output.ansible_facts.docker_network.IPAM.Config[0].Gateway }}"
  tags:
    - services

- name: Add sftpaccess group
  group:
    name: sftpaccess
    gid: 2200
    state: present
  become: yes
  tags:
    - services

- name: Add arq user
  user:
    name: arq
    group: sftpaccess
    uid: 2201
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add deploy user to media group
  user:
    name: "{{ deploy_user }}"
    groups: media
    append: yes
    createhome: no
  become: yes
  tags:
    - services

- name: Create mount points
  file:
    dest: "{{item.path}}"
    state: directory
    owner: "{{item.owner}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  become: yes
  tags:
    - services
    - focus
  with_items:
    - {path: '/mnt/media/Movies',           owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/media/Music',            owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/media/TV',               owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/media/.tmp',             owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/media/.tmp/sabnzbd',     owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/media/.tmp/couchpotato', owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/media/.tmp/sickrage',    owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/docker',                 owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/brumath',                owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/legacy',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/pictures',               owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/sftp',                   owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/videos',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}

- name: Copy the unit files
  copy:
    src: systemd/{{ item }}.service
    dest: /etc/systemd/system/{{ item }}.service
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - services
  notify:
    # - Restart {{ item }}
  with_items:
    - compose
    - sftp
    - speedtest

- name: Enable the services
  systemd:
    name: "{{ item }}"
    enabled: yes
    daemon_reload: yes
  become: yes
  tags:
    - services
  with_items:
    - compose
    - sftp
    - speedtest

- import_tasks: avahi.yml
- import_tasks: samba.yml
- import_tasks: traefik.yml
- import_tasks: traefik-auth-cloudflare.yml
- import_tasks: plex.yml
- import_tasks: sabnzbd.yml
- import_tasks: couchpotato.yml
- import_tasks: sickrage.yml
