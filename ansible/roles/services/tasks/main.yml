---

- name: Create a network
  docker_network:
    name: usenet
  become: yes
  tags:
    - services
    - couchpotato
    - sickrage
    - sabnzbd
  register: usenet_docker_network_output

- name: Set fact with usenet docker network gateway
  set_fact:
    usenet_docker_network_gateway: "{{ usenet_docker_network_output.ansible_facts.docker_network.IPAM.Config[0].Gateway }}"
  tags:
    - services
    - couchpotato
    - sickrage
    - sabnzbd

- name: Create mount points
  file:
    dest: "{{item.path}}"
    state: directory
    owner: "{{item.owner}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  become: yes
  tags:
    - services
  with_items:
    - {path: '/mnt/services',               owner: 'root',              group: 'root',              mode: '0775'}
    - {path: '/mnt/brumath',                owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/legacy',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/pictures',               owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}
    - {path: '/mnt/videos',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0775'}

- name: Copy the unit file
  copy:
    src: systemd/compose.service
    dest: /etc/systemd/system/compose.service
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - services
  notify:
    - Restart compose

- name: Enable the service
  systemd:
    name: compose
    enabled: yes
    daemon_reload: yes
  become: yes
  tags:
    - services

- name: Copy the sort script
  copy:
    src: sort_ini.py
    dest: /usr/local/bin/sort-ini
    owner: root
    group: root
    mode: 0755
  become: yes
  tags:
    - services
- name: Copy the maintenance script
  copy:
    src: usenet-maintenance.sh
    dest: /usr/local/bin/usenet-maintenance
    owner: root
    group: root
    mode: 0755
  become: yes
  tags:
    - services

- name: Copy the unit file
  copy:
    src: systemd/{{ item }}
    dest: /etc/systemd/system/{{ item }}
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - services
  with_items:
    - usenet-maintenance.path
    - usenet-maintenance.timer
    - usenet-maintenance.service
  notify:
    - Restart usenet-maintenance

- name: Enable the service
  systemd:
    name: "{{ item }}"
    enabled: yes
    daemon_reload: yes
  become: yes
  with_items:
    - usenet-maintenance.path
    - usenet-maintenance.timer
  tags:
    - services

- import_tasks: avahi.yml
- import_tasks: coredns.yml
- import_tasks: unifi.yml
- import_tasks: couchpotato.yml
- import_tasks: plex.yml
- import_tasks: portainer.yml
- import_tasks: remote-ssh.yml
- import_tasks: sabnzbd.yml
- import_tasks: samba.yml
- import_tasks: sickrage.yml
- import_tasks: speedtest.yml
- import_tasks: gogs.yml
- import_tasks: traefik.yml
- import_tasks: gmvault.yml
