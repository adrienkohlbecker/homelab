---

- name: Create a network
  docker_network:
    name: usenet
  become: yes
  tags:
    - services
  register: usenet_docker_network_output

- name: Set fact with usenet docker network gateway
  set_fact:
    usenet_docker_network_gateway: "{{ usenet_docker_network_output.ansible_facts.docker_network.IPAM.Config[0].Gateway }}"
  tags:
    - services

- name: Create a network
  docker_network:
    name: traefik
  become: yes
  tags:
    - services

- name: Create a network
  docker_network:
    name: traefik-auth
  become: yes
  tags:
    - services

- name: Add avahi group
  group:
    name: avahi
    gid: 125
    system: yes
    state: present
  become: yes
  tags:
    - services

- name: Add avahi user
  user:
    name: avahi
    group: avahi
    uid: 125
    createhome: no
    comment: Avahi mDNS daemon,,,
    home: /var/run/avahi-daemon
    shell: /bin/false
    system: yes
    state: present
  become: yes
  tags:
    - services

- name: Add sftpaccess group
  group:
    name: sftpaccess
    gid: 2200
    state: present
  become: yes
  tags:
    - services

- name: Add plex user
  user:
    name: plex
    group: media
    uid: 2005
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add sonos user
  user:
    name: sonos
    group: media
    uid: 2006
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add arq user
  user:
    name: arq
    group: sftpaccess
    uid: 2201
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add deploy user to media group
  user:
    name: "{{ deploy_user }}"
    groups: media
    append: yes
    createhome: no
  become: yes
  tags:
    - services

- name: Create mount points
  file:
    dest: "{{item.path}}"
    state: directory
    owner: "{{item.owner}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  become: yes
  tags:
    - services
  with_items:
    - {path: '/mnt/media/Movies',           owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/Music',            owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/TV',               owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/.tmp',             owner: 'media',             group: 'media',             mode: '0775'}
    - {path: '/mnt/media/.tmp/sabnzbd',     owner: 'media',             group: 'media',             mode: '0775'}
    - {path: '/mnt/media/.tmp/couchpotato', owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/.tmp/sickrage',    owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/docker',                 owner: 'root',              group: 'media',             mode: '0774'}
    - {path: '/mnt/docker/traefik',         owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/portainer',       owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/sabnzbd',         owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/sickrage',        owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/couchpotato',     owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/gitlab',          owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/gitlab-storage',  owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/plex',            owner: 'plex',              group: 'media',             mode: '0774'}
    - {path: '/mnt/brumath',                owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}
    - {path: '/mnt/legacy',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}
    - {path: '/mnt/pictures',               owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}
    - {path: '/mnt/sftp',                   owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/videos',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}

- name: Copy docker-dbus apparmor profile
  copy:
    src: docker-dbus.apparmor
    dest: /etc/apparmor.d/docker-dbus
    mode: 0644
    owner: root
    group: root
  become: yes
  register: docker_dbus
  tags:
    - services

- name: Register new apparmor profile
  shell: apparmor_parser -r -W /etc/apparmor.d/docker-dbus
  when: docker_dbus is changed
  become: yes
  tags:
    - services

- name: Copy avahi dbus config
  copy:
    src: avahi-dbus.conf
    dest: /etc/dbus-1/system.d/avahi-dbus.conf
    mode: 0644
    owner: root
    group: root
  become: yes
  tags:
    - services

- name: Download client ca from cloudflare
  get_url:
    url: https://support.cloudflare.com/hc/en-us/article_attachments/201243967/origin-pull-ca.pem
    dest: /mnt/docker/traefik/cloudflare-origin-pull-ca.pem
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - services

- name: Configure traefik
  template:
    src: traefik.toml.j2
    dest: /mnt/docker/traefik/traefik.toml
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart traefik

- name: Configure sickrage
  template:
    src: sickrage.ini.j2
    dest: /mnt/docker/sickrage/config.ini
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart sickrage

- name: Configure sabnzbd
  template:
    src: sabnzbd.ini.j2
    dest: /mnt/docker/sabnzbd/sabnzbd.ini
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart sabnzbd

- name: Configure sabnzbd
  template:
    src: autoProcessMedia.cfg.j2
    dest: /mnt/docker/sabnzbd/autoProcessMedia.cfg
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart sabnzbd

- name: Configure couchpotato
  template:
    src: couchpotato.ini.j2
    dest: /mnt/docker/couchpotato/settings.conf
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart couchpotato

- name: Create acme.json
  file:
    dest: /mnt/docker/traefik/acme.json
    state: file
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart traefik

- name: Create env.d directory
  file:
    dest: /etc/env.d
    state: directory
    owner: root
    group: root
    mode: 0700
  become: yes
  tags:
    - services

- name: Copy the credentials
  template:
    src: environment/{{ item }}.j2
    dest: /etc/env.d/{{ item }}
    owner: root
    group: root
    mode: 0600
  become: yes
  tags:
    - services
  notify:
    - Restart {{ item }}
  with_items:
    - traefik
    - samba

- name: Copy the unit files
  copy:
    src: systemd/{{ item }}.service
    dest: /etc/systemd/system/{{ item }}.service
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - services
  notify:
    # - Restart {{ item }}
  with_items:
    - avahi
    - compose
    - couchpotato
    - traefik
    - traefik-auth-cloudflare
    - plex
    - sabnzbd
    - samba
    - sftp
    - sickrage
    - portainer
    - speedtest

- name: Enable the services
  systemd:
    name: "{{ item }}"
    enabled: yes
    daemon_reload: yes
  become: yes
  tags:
    - services
  with_items:
    - avahi
    - compose
    - couchpotato
    - traefik
    - traefik-auth-cloudflare
    - plex
    - sabnzbd
    - samba
    - sftp
    - sickrage
    - portainer
    - speedtest
