---

- name: Create ejson keys directory
  file:
    dest: /opt/ejson/keys
    state: directory
    recurse: true
    owner: root
    group: root
    mode: 0755
  become: yes
  tags:
    - services

- name: Add avahi group
  group:
    name: avahi
    gid: 125
    system: yes
    state: present
  become: yes
  tags:
    - services

- name: Add avahi user
  user:
    name: avahi
    group: avahi
    uid: 125
    createhome: no
    comment: Avahi mDNS daemon,,,
    home: /var/run/avahi-daemon
    shell: /bin/false
    system: yes
    state: present
  become: yes
  tags:
    - services

- name: Add sftpaccess group
  group:
    name: sftpaccess
    gid: 2200
    state: present
  become: yes
  tags:
    - services

- name: Add plex user
  user:
    name: plex
    group: media
    uid: 2005
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add sonos user
  user:
    name: sonos
    group: media
    uid: 2006
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add arq user
  user:
    name: arq
    group: sftpaccess
    uid: 2201
    createhome: no
    state: present
  become: yes
  tags:
    - services

- name: Add deploy user to media group
  user:
    name: "{{ deploy_user }}"
    groups: media
    append: yes
    createhome: no
  become: yes
  tags:
    - services

- name: Create mount points
  file:
    dest: "{{item.path}}"
    state: directory
    owner: "{{item.owner}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  become: yes
  tags:
    - services
  with_items:
    - {path: '/mnt/media/Movies',           owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/TV',               owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/Music',            owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/Other',            owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/.tmp',             owner: 'media',             group: 'media',             mode: '0775'}
    - {path: '/mnt/media/.tmp/sabnzbd',     owner: 'media',             group: 'media',             mode: '0775'}
    - {path: '/mnt/media/.tmp/couchpotato', owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/media/.tmp/sickrage',    owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/docker',                 owner: 'root',              group: 'media',             mode: '0774'}
    - {path: '/mnt/docker/sabnzbd',         owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/docker/sickrage',        owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/docker/couchpotato',     owner: 'media',             group: 'media',             mode: '0774'}
    - {path: '/mnt/docker/gitlab',          owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/gitlab-storage',  owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/docker/plex',            owner: 'plex',              group: 'media',             mode: '0774'}
    - {path: '/mnt/brumath',                owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}
    - {path: '/mnt/legacy',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}
    - {path: '/mnt/pictures',               owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}
    - {path: '/mnt/sftp',                   owner: 'root',              group: 'root',              mode: '0755'}
    - {path: '/mnt/videos',                 owner: '{{ deploy_user }}', group: '{{ deploy_user }}', mode: '0774'}

- name: Copy the assume_role script
  copy:
    src: assume_role.sh
    dest: /usr/local/bin/assume_role
    mode: 755
    owner: root
    group: root
  become: yes
  tags:
    - services

- name: Copy docker-dbus apparmor profile
  copy:
    src: docker-dbus.apparmor
    dest: /etc/apparmor.d/docker-dbus
    mode: 0644
    owner: root
    group: root
  become: yes
  register: docker_dbus
  tags:
    - services

- name: Register new apparmor profile
  shell: apparmor_parser -r -W /etc/apparmor.d/docker-dbus
  when: docker_dbus|changed
  become: yes
  tags:
    - services

- name: Copy avahi dbus config
  copy:
    src: avahi-dbus.conf
    dest: /etc/dbus-1/system.d/avahi-dbus.conf
    mode: 0644
    owner: root
    group: root
  become: yes
  tags:
    - services

- name: Install configuration
  git:
    repo: https://github.com/kohlby/compose.git
    dest: /opt/services
    accept_hostkey: True
    update: yes
  become: yes
  notify:
    - Reload unit
    - Restart compose
  tags:
    - services

- name: Enable service
  command: /opt/services/install.sh
  args:
    chdir: /opt/services
  register: command_result
  changed_when: '"Created symlink from" in command_result.stderr'
  become: yes
  notify:
    - Reload unit
    - Restart compose
  tags:
    - services

- name: Copy the update script
  copy:
    src: services_update.sh
    dest: /usr/local/bin/services_update
    mode: 755
  become: yes
  tags:
    - services

- name: Schedule the update script
  cron:
    name: services_update
    minute: 0
    hour: 5
    job: /usr/local/bin/services_update
    user: root
    cron_file: ansible_services_update
  become: yes
  tags:
    - services
