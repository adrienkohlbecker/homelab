---

- name: Install virtualization tools
  apt:
    pkg: "{{item}}"
    state: installed
  become: yes
  tags:
    - virtualization
  with_items:
    - qemu-kvm
    - virt-manager
    - libgl1-mesa-glx # https://bugs.launchpad.net/ubuntu/+source/virt-manager/+bug/1550983

- name: Download virtio drivers for windows
  get_url:
    url: https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.118-2/virtio-win-0.1.118.iso
    dest: /var/lib/libvirt/images/virtio-win-0.1.118.iso
    owner: root
    group: root
  become: yes
  tags:
    - virtualization

- name: Define vms # TODO: Make indepotent
  virt:
    name: "{{ item }}"
    command: define
    xml: "{{ lookup('file', item+'.xml') }}"
  with_items:
    - Ubuntu_base
    - HTPC
    - OSX
  become: yes
  changed_when: false
  tags:
    - virtualization

- name: Add deploy user to libvirtd group
  user:
    name: "{{ deploy_user }}"
    groups: libvirtd
    append: yes
  become: yes
  tags:
    - virtualization

- name: Create mount points
  file:
    dest: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0711
  become: yes
  tags:
    - snapraid
  with_items:
    - /mnt/vms
    - /var/lib/libvirt/images
