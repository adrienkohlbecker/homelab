---

- name: Install virtualization tools
  apt:
    pkg: "{{item}}"
    state: installed
  become: yes
  tags:
    - virtualization
  with_items:
    - qemu-kvm
    - virt-manager
    - libgl1-mesa-glx # https://bugs.launchpad.net/ubuntu/+source/virt-manager/+bug/1550983

- name: Download virtio drivers for windows
  get_url:
    url: https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.117-1/virtio-win-0.1.117.iso
    dest: /var/lib/libvirt/images/virtio-win-0.1.117.iso
    owner: root
    group: root
  become: yes
  tags:
    - virtualization

- name: Define vms # TODO: Make indepotent
  virt:
    name: "{{ item }}"
    command: define
    xml: "{{ lookup('file', item+'.xml') }}"
  with_items:
    - Ubuntu_base
    - HTPC
    - OSX
  become: yes
  changed_when: false
  tags:
    - virtualization

# TODO: Restarting network fails with
#   run-parts: /etc/network/if-up.d/ubuntu-fan exited with return code 1
#   Failed to bring up enp0s5.
- name: Configure networking
  copy:
    src: interfaces
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: 0644
  become: yes
  notify:
    # - Restart networking
    - Ask to reboot
  tags:
    - virtualization
