---

- name: Configure networking
  template:
    src: "config.{{ inventory_hostname_short }}.yaml.j2"
    dest: /etc/netplan/01-netcfg.yaml
    owner: root
    group: root
    mode: 0644
  become: yes
  notify:
    - Apply netplan
  tags:
    - networking

- name: Add wireguard repository
  apt_repository:
    repo: ppa:wireguard/wireguard
    state: present
  become: yes
  tags:
    - networking

- name: Install wireguard
  apt:
    pkg: wireguard
    state: present
  become: yes
  tags:
    - networking

- name: Copy the network file
  copy:
    src: wg0.network
    dest: /etc/systemd/network/wg0.network
    owner: root
    group: root
    mode: 0644
  become: yes
  tags:
    - networking
  notify:
    - Reload systemd
    - Restart systemd-networkd

- name: Copy the netdev file
  template:
    src: wg0.netdev.j2
    dest: /etc/systemd/network/wg0.netdev
    owner: root
    group: systemd-network
    mode: 0640
  become: yes
  tags:
    - networking
  notify:
    - Reload systemd
    - Restart systemd-networkd
