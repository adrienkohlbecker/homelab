---

- hosts: all
  roles:
    - base
    - ntp
    - ssh
    - mailer
    - datadog
    - user
    - dotfiles

- hosts: unifi
  roles: []

- hosts: hypervisor
  roles:
    - grub
    - networking
    - duo
    - zfs
    - smart
    - hdparm
    - ups
    - ipmi
    - snapraid
    - mergerfs
    - docker
    - services
    - letsencrypt

  post_tasks:

    - name: Check if a reboot is required
      shell: "[ -f /var/run/reboot-required ]"
      failed_when: false
      register: reboot_required
      changed_when: reboot_required.rc == 0
      tags:
        - always

    - name: restart machine
      shell: sleep 2 && shutdown -r now "Ansible updates triggered"
      async: 1
      poll: 0
      become: true
      ignore_errors: true
      when: reboot_required is changed
      tags:
        - always

    - name: waiting for server to come back
      wait_for:
        port: 22
        host: "{{ ansible_ssh_host }}"
        search_regex: OpenSSH
        delay: 10
      delegate_to: 127.0.0.1
      become: false
      when: reboot_required is changed
      tags:
        - always
