

- name: Install mbuffer
  apt:
    package:
      - mbuffer
    cache_valid_time: 3600
  become: yes
  tags:
    - zfs

- name: Install pip deps
  pip:
    name: zfs-autobackup
  become: yes
  tags:
    - zfs

- name: Copy the zfs tool
  template:
    src: zfs_backup.sh.j2
    dest: /usr/local/bin/zfs_backup
    mode: "0755"
    owner: root
    group: root
    backup: yes
  become: yes
  tags:
    - zfs

- name: Schedule the backup script
  cron:
    name: zfs_backup
    minute: 20
    hour: 0
    job:  "/usr/bin/systemd-cat --identifier zfs_backup /usr/local/bin/zfs_backup"
    user: root
    cron_file: ansible_zfs_backup
    backup: yes
  become: yes
  tags:
    - zfs
