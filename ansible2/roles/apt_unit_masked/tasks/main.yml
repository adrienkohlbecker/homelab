- name: Gather package facts
  package_facts:
    manager: apt
  no_log: yes
  check_mode: false

- when: pkg not in ansible_facts.packages
  block:

  - name: Prevent daemons from starting during install
    template:
      src: policy-rc.d
      dest: /usr/sbin/policy-rc.d
      owner: root
      group: root
      mode: "0755"
    register: policy_rcd
    become: yes

  - name: Install {{ pkg }}
    when: condition is not defined or condition
    apt:
      pkg:
        - "{{ pkg }}"
      cache_valid_time: 3600
    register: apt_unit_masked
    become: yes

  always:

  - name: Remove policy file
    when: policy_rcd.changed
    file:
      dest: /usr/sbin/policy-rc.d
      state: absent
    become: yes
