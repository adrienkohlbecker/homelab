- name: Gather package facts
  package_facts:
    manager: apt
  no_log: yes
  check_mode: false
  tags:
    - minio

- when: '"mcli" not in ansible_facts.packages or ansible_facts.packages["mcli"][0].version != "20221029100923.0.0"'
  block:

    - name: Create temporary file
      tempfile:
        state: file
        suffix: .deb
      register: tempfile

    - name: Download mcli deb
      check_mode: false
      get_url:
        url: https://dl.min.io/client/mc/release/linux-amd64/archive/mcli_20221029100923.0.0_amd64.deb
        dest: "{{ tempfile.path }}"
        mode: '0644'
        owner: root
        group: root
        checksum: sha256:796d0e7a5c6e59020e02ecb3a46f9ec771a26ecc0dfc45d76fe6e351d75cf4c7

    - name: Install mcli
      apt:
        deb: "{{ tempfile.path }}"
      register: mcli_installed

    - name: Delete temp file
      file:
         path: "{{ tempfile.path }}"
         state: absent

  become: yes
  tags:
    - minio

- name: Configure alias
  when: not (ansible_check_mode and mcli_installed.changed)
  command: mcli alias set default https://minio.{{ inventory_hostname }}.{{ domain }} {{ minio_root_user }} {{ minio_root_password }}
  args:
    creates: ~/.mcli/config.json
  tags:
    - minio
