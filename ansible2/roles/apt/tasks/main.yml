- name: Ensure apt is using the correct mirror for ubuntu
  replace:
    path: /etc/apt/sources.list
    regexp: 'deb(-src)? http:\/\/([^ \/]+)\/ubuntu'
    replace: 'deb\1 http://archive.ubuntu.com/ubuntu'
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: apt_mirror
  tags:
    - apt

- name: force apt update
  when: apt_mirror.changed
  apt:
    update_cache: yes
  become: yes
  tags:
    - apt

- name: apt safe-upgrade
  apt:
    upgrade: safe
    cache_valid_time: 3600
  become: yes
  tags:
    - apt
