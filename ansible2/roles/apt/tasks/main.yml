- name: Ensure apt is using the correct mirror for ubuntu
  replace:
    path: /etc/apt/sources.list
    regexp: 'deb(-src)? http:\/\/([^ \/]+)\/ubuntu'
    replace: 'deb\1 http://archive.ubuntu.com/ubuntu'
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: apt_mirror
  tags:
    - apt

- name: force apt update
  when: apt_mirror.changed
  apt:
    update_cache: yes
  become: yes
  tags:
    - apt

- name: apt safe-upgrade
  apt:
    upgrade: safe
    cache_valid_time: 3600
  become: yes
  tags:
    - apt

- name: Install unattended-upgrades
  apt:
    pkg:
      - update-notifier-common
      - unattended-upgrades
    cache_valid_time: 3600
    state: present
  become: yes
  tags:
    - apt

- name: Setup unattended-upgrades (20auto-upgrades)
  copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: apt_unattended_20
  tags:
    - apt

- name: Setup unattended-upgrades (50unattended-upgrades)
  copy:
    src: 50unattended-upgrades
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: apt_unattended_50
  tags:
    - apt

- name: Dry-run unattended-upgrades
  when: apt_unattended_20.changed or apt_unattended_50.changed
  command: unattended-upgrades --dry-run --verbose
  changed_when: false
  become: yes
  tags:
    - apt
