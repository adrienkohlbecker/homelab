- name: Configure logrotate compression {{ item }}
  when: condition | default(true)
  replace:
    regexp: ^(\s*)(# )?compress(.*)$
    replace: "{{ zfs_root | ternary(disable, enable) }}"
    path: "{{ item }}"
    backup: true
  register: logrotate_conf
  become: yes
  vars:
    disable: '\1# compress # zfs already compresses disk contents'
    enable: '\1compress'

- name: Check apt source for {{ item }}
  when: logrotate_conf.changed
  command: dpkg -S {{ item }}
  check_mode: false
  changed_when: false
  failed_when:
    - logrotate_conf_dpkg.rc != 0
    - '"no path found matching pattern" not in logrotate_conf_dpkg.stderr'
  register: logrotate_conf_dpkg
  become: yes

- name: Divert {{ item }}
  when: 'logrotate_conf.changed and "no path found matching pattern" not in logrotate_conf_dpkg.stderr'
  community.general.dpkg_divert:
    path: "{{ item }}"
    divert: "{{ item }}.dpkg-dist" # so it is not included by logrotate.conf
  become: yes
