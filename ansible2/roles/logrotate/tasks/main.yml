- import_role:
    name: apt_unit_masked
  vars:
    pkg: logrotate
    unit: logrotate.service
  tags:
    - logrotate

- name: Gather list of config files
  find:
    paths:
      - /etc/logrotate.d
  register: logrotate_confs
  become: yes
  tags:
    - logrotate

- block:

  - name: Divert configuration files
    community.general.dpkg_divert:
      path: "{{ item }}"
    loop: "{{ paths|flatten }}"
    become: yes
    tags:
      - logrotate

  - name: Disable compression on ZFS roots
    lineinfile:
      regexp: "{{ zfs_root | ternary(enable.regexp, disable.regexp) }}"
      line: "{{ zfs_root | ternary(enable.line, disable.line) }}"
      dest: "{{ item }}"
      backrefs: true
      backup: true
    loop: "{{ paths|flatten }}"
    register: logrotate_conf
    become: yes
    vars:
      enable:
        regexp: '^(\s*)compress'
        line: '\1# compress # zfs already compresses disk contents'
      disable:
        regexp: '^(\s*)# compress # zfs already compresses disk contents'
        line: '\1compress'
    tags:
      - logrotate

  vars:
    paths:
      - "{{ logrotate_confs.files | map(attribute='path') }}"
      - /etc/logrotate.conf

- name: Enable the service
  systemd:
    name: logrotate
    enabled: yes
  become: yes
  tags:
    - logrotate

- name: Start the service
  systemd:
    name: logrotate
    state: started
  become: yes
  register: systemd_started
  tags:
    - logrotate

- name: Restart the service
  when: logrotate_conf.changed and not systemd_started.changed
  systemd:
    name: logrotate
    state: restarted
  become: yes
  tags:
    - logrotate
