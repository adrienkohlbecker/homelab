- name: Install logrotate
  apt:
    pkg:
      - logrotate
    cache_valid_time: 3600
  become: yes
  tags:
    - logrotate

- name: Gather list of config files
  find:
    paths:
      - /etc/logrotate.d
  register: logrotate_confs
  become: yes
  tags:
    - logrotate

- name: Disable compression on ZFS roots
  lineinfile:
    regexp: "{{ zfs_root | ternary(enable.regexp, disable.regexp) }}"
    line: "{{ zfs_root | ternary(enable.line, disable.line) }}"
    dest: "{{ item }}"
    backrefs: true
  loop: "{{ paths|flatten }}"
  become: yes
  vars:
    enable:
      regexp: '^(\s*)compress'
      line: '\1# compress # zfs already compresses disk contents'
    disable:
      regexp: '^(\s*)# compress # zfs already compresses disk contents'
      line: '\1compress'
    paths:
      - "{{ logrotate_confs.files | map(attribute='path') }}"
      - /etc/logrotate.conf
  tags:
    - logrotate
